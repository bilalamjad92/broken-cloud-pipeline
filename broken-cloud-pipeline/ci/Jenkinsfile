pipeline {
    agent any
    
    environment {
        AWS_REGION = 'eu-central-1'
    }
    
    stages {
        stage('Checkout') {
            steps {
                // Use the correct credential type
                withCredentials([usernamePassword(credentialsId: 'github-cred-id', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASS')]) {
                    git url: 'https://github.com/bilalamjad92/broken-cloud-pipeline.git',
                        credentialsId: 'github-cred-id',
                        branch: 'main'
                }
                
                // Check for ci directory
                sh '''
                    if [ -d ci ]; then
                        echo "ci directory found successfully!"
                    else
                        echo "Error: ci directory not found!"
                        exit 1
                    fi
                '''
            }
        }
        
        stage('Build and Deploy Application') {
            steps {
                dir('ci/app') {
                    sh 'docker build -t cloud-app:latest .'
                    sh 'docker run -d -p 8080:80 --name cloud-app cloud-app:latest'
                }
            }
        }
        
        stage('Update Jenkins Container') {
            steps {
                dir('ci/jenkins') {
                    sh 'chmod +x verify_health.sh'
                    sh './verify_health.sh'
                }
            }
        }
    }
    
    post {
        always {
            // Handle SNS notification with error handling
            script {
                try {
                    withAWS(region: env.AWS_REGION) {
                        def message = currentBuild.result == 'SUCCESS' ? 'Pipeline SUCCESS' : 'Pipeline FAILURE'
                        sh "aws sns publish --topic-arn arn:aws:sns:eu-central-1:216989105561:pipeline-notifications --message '${message} - Build #${BUILD_NUMBER}'"
                    }
                } catch (Exception e) {
                    echo "Warning: Could not send SNS notification: ${e.message}"
                    // Continue execution without failing the pipeline
                }
            }
        }
    }
}
